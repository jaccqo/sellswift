<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Create Organization</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Theme Config Js -->
    <script src="assets/js/hyper-config.js"></script>

    <!-- App css -->
    <link href="assets/css/app-saas.min.css" rel="stylesheet" type="text/css" id="app-style" />

    <!-- Icons css -->
    <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="assets/css/fontawesome-free-6.5.2-web/css/all.css">

    <!-- FilePond CSS -->
    <link href="https://unpkg.com/filepond/dist/filepond.min.css" rel="stylesheet" />

    <script src="assets/js/jquery.min.js"></script>

    <!-- FilePond JS -->
    <script src="https://unpkg.com/filepond/dist/filepond.min.js"></script>
    <script src="https://unpkg.com/filepond-plugin-file-encode/dist/filepond-plugin-file-encode.min.js"></script>

    <link rel="stylesheet" href="assets/vendor/jquery-toast-plugin/jquery.toast.min.css" />

</head>

<body class="authentication-bg">

    <div class="position-absolute start-0 end-0 start-0 bottom-0 w-100 h-100">
        <svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%' viewBox='0 0 800 800'>
            <g fill-opacity='0.22'>
                <circle style="fill: rgba(var(--ct-warning-rgb), 0.1);" cx='400' cy='400' r='600' />
                <circle style="fill: rgba(var(--ct-warning-rgb), 0.2);" cx='400' cy='400' r='500' />
                <circle style="fill: rgba(var(--ct-warning-rgb), 0.3);" cx='400' cy='400' r='300' />
                <circle style="fill: rgba(var(--ct-warning-rgb), 0.4);" cx='400' cy='400' r='200' />
                <circle style="fill: rgba(var(--ct-warning-rgb), 0.5);" cx='400' cy='400' r='100' />
            </g>
        </svg>
    </div>

    <div class="container">
        <nav id="navbar" class="navbar navbar-expand-lg justify-content-end fixed-top rounded-lg border-0">
            <div class="resize-btns ml-auto d-flex align-items-center">
                <div class="btn-icon p-2">
                    <i class="ri-subtract-line" id="minimize-button"></i>
                </div>
                <div class="btn-icon p-2">
                    <i class="ri-checkbox-multiple-blank-line" id="maximize-button"></i>
                </div>
                <div class="btn-icon p-2">
                    <i class="ri-close-line" id="close-button"></i>
                </div>
            </div>
        </nav>
    </div>

    <div class="account-pages pt-5 pt-sm-5 pb-4 pb-sm-5 position-relative d-flex justify-content-center align-items-center">
        <div class="container h-50">
            <div class="row justify-content-center">
                <div class="col-xxl-4 col-lg-5">
                    <div class="card ribbon-box">
                        <!-- Logo-->
                        <div class="ribbon ribbon-dark">
                            <span><img src="assets/images/logo.png" alt="" height="30"></span> Create Organization
                        </div>

                        <div class="card-body p-4">
                            <div class="text-center w-75 m-auto">
                                <h4 class="text-dark-50 text-center mt-0 fw-bold">Create Your Organization</h4>
                                <p class="text-muted mb-4">Enter your organization details and upload your logo.</p>
                            </div>

                            <form id="createOrgForm">
                                <!-- Right -->
                                <div class="card ribbon-box d-none" id="orgMessage"></div> <!-- end card-->

                                <div class="mb-3">
                                    <label for="orgName" class="form-label">Organization Name</label>
                                    <input class="form-control" type="text" id="orgName" name="orgName" placeholder="Enter organization name" required>
                                </div>

                                <!-- Logo Upload -->
                                <div class="mb-3">
                                    <label for="orgLogo" class="form-label">Organization Logo</label>
                                    <input type="file" class="filepond" id="orgLogo" name="orgLogo">
                                </div>

                                <div class="mb-3">
                                    <label for="emailaddress" class="form-label">Email address</label>
                                    <input class="form-control" type="email" name="email" id="emailaddress" required placeholder="Enter your email" required>
                                </div>

                                <div class="mb-3 text-center">
                                    <button class="btn btn-warning createOrg" type="submit"> Create Organization </button>

                                    <button class="btn btn-warning d-none org-loading" type="button" disabled>
                                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                        Creating organization...
                                    </button>
                                </div>
                            </form>

                            <!-- Organization Secret Key Section -->
                            <div id="orgSecretKeyMessage" class="d-none mt-3">
                                <h6 class="text-danger text-center">Important: Copy this key and keep it secure!</h6>
                                <div class="card-body">
                                    <strong>Organization Secret Key:</strong>
                                    <div class="alert alert-warning d-flex justify-content-between align-items-center" role="alert">
                                        
                                        <span id="organizationKey"></span>
                                        <button id="copyKeyBtn" class="btn btn-outline-secondary btn-sm">Copy</button>
                                    </div>
                                    <p class="text-muted text-center">This key will be required for signing up and logging into the system.</p>
                                </div>
                            </div>
                        </div> <!-- end card-body -->
                    </div>
                    <!-- end card -->

                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <p class="text-muted">Already have an account? <a href="pages-login.html" class="text-muted ms-1"><b>Log In</b></a></p>
                        </div> <!-- end col-->
                    </div>
                    <!-- end row -->
                </div> <!-- end col -->
            </div>
        </div>
        <!-- end row -->
    </div>

    <!-- Terms Modal -->
    <div id="termsModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body p-4">
                    <div class="text-center">
                        <i class="mdi mdi-information-outline h1 text-info"></i>
                        <h4 class="mt-2">Terms and Conditions</h4>
                        <p class="mt-3">Please review and accept the terms and conditions before proceeding.</p>
                        <button type="button" class="btn btn-info my-2" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <footer class="footer footer-alt">
        Â© RUHMTECH - v1.0.0
    </footer>

    <!-- Vendor js -->
    <script src="assets/js/vendor.min.js"></script>

    <!-- App js -->
    <script src="assets/js/app.min.js"></script>

    <script src="assets/js/win-controls.js"></script>

    <script src="assets/vendor/jquery-toast-plugin/jquery.toast.min.js"></script>

    <!-- Toastr Demo js -->
    <script src="assets/js/pages/demo.toastr.js"></script>

    <!-- FilePond Setup -->
    <script>
        // Wrapping everything in an async IIFE (Immediately Invoked Function Expression)
        (async function() {
            // Function to get user info
            const get_user = async () => {
                try {
                    const user_info = await ipcRenderer.GetUser();
                    return user_info;
                } catch (error) {
                    console.error("Error getting user information:", error.message);
                }
            };
    
            // Toast function to display feedback messages
            function showToast(heading, text, position, loaderBg, icon, hideAfter = 3000, stack = 1, showHideTransition = "fade") {
                const options = {
                    heading: heading,
                    text: text,
                    position: position,
                    loaderBg: loaderBg,
                    icon: icon,
                    hideAfter: hideAfter,
                    stack: stack,
                    showHideTransition: showHideTransition
                };
                $.toast().reset("all");
                $.toast(options);
            }
    
            // Get user information
            const users_information = await get_user();
            let base_url = users_information.base_url;
    
            // Register the plugin
            FilePond.registerPlugin(FilePondPluginFileEncode);
    
            // Turn all file input elements into ponds
            const pond = FilePond.create(document.querySelector('.filepond'));
    
            // Set up the form submission
            $('#createOrgForm').submit(async function(event) {
                event.preventDefault();
    
                const formData = new FormData(this);
                const orgName = $('#orgName').val();
                const email = $('#emailaddress').val();
                const logoFile = pond.getFiles()[0];
    
                // Convert FilePond file to base64
                let logoBase64 = "";
                if (logoFile) {
                    logoBase64 = logoFile.getFileEncodeBase64String();
                }
    
                // Create the organization data object
                const orgData = {
                    orgName: orgName,
                    email: email,
                    logo: logoBase64
                };
    
                // Show spinner and hide submit button
                const submitButton = $('.createOrg');
                const loadingButton = $('.org-loading');
    
                submitButton.addClass('d-none');
                loadingButton.removeClass('d-none');
    
                try {
                    // Send the data to the server
                    const response = await $.ajax({
                        type: 'POST',
                        url: `${base_url}/create-organization`,
                        data: JSON.stringify(orgData),
                        contentType: 'application/json'
                    });
    
                    if (response.status === "success") {
                        $('#orgMessage').html(`<div class="card-body"><h6 class="text-success">${response.message}</h6></div>`);
                        $('#orgMessage').removeClass('d-none');
    
                        // Show secret key and instructions to copy it
                        $('#organizationKey').text(response.secret_key);
                        $('#orgSecretKeyMessage').removeClass('d-none');
                    }
                } catch (error) {
                    $('#orgMessage').html(`<div class="card-body"><h6 class="text-danger">Failed to create organization: ${error.responseText}</h6></div>`);
                    $('#orgMessage').removeClass('d-none');
                    console.error('Error creating organization:', error.message);
                } finally {
                    // Hide spinner and show submit button
                    submitButton.removeClass('d-none');
                    loadingButton.addClass('d-none');
                }
            });
    
            // Copy secret key to clipboard
            $('#copyKeyBtn').click(function() {
                const secretKey = $('#organizationKey').text();
                navigator.clipboard.writeText(secretKey).then(function() {
                    $('#copyKeyBtn').text('Copied').addClass('btn-success').removeClass('btn-outline-secondary');
                }, function() {
                    console.error('Failed to copy key');
                });
            });
    
        })(); // Immediately Invoked Function Expression (IIFE)
    </script>
    
</body>

</html>
